# MLOps Platform - Infrastructure as Code (IaC)

## Overview

This IaC implementation automates the complete deployment of the AI-Augmented MLOps Platform, transforming a manual 2-week setup into a **15-minute automated deployment**.

### What Gets Automated

√¢≈ì‚Ä¶ **Cloud Infrastructure** (Terraform)
- GCP VM provisioning (e2-small, 2 vCPU, 2GB RAM)
- VPC networking and firewall rules
- Service accounts and IAM roles

√¢≈ì‚Ä¶ **Platform Configuration** (Ansible)
- k3s control plane installation
- Tailscale VPN setup
- ArgoCD deployment and configuration
- MLflow with persistent storage
- Monitoring stack (Prometheus, Grafana, Alertmanager)

√¢≈ì‚Ä¶ **On-Premises Setup** (k3d + Scripts)
- k3d cluster creation with proper port mappings
- Tailscale integration for hybrid connectivity
- Cluster registration with ArgoCD

√¢≈ì‚Ä¶ **Operational Tools**
- Pre-flight validation checks
- Post-deployment verification
- Automated rollback on failure
- Health checks and status monitoring

---

## Quick Start

### Prerequisites

Install required tools:

```bash
# Terraform
brew install terraform  # macOS
# OR
wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip

# Ansible
pip install ansible ansible-lint

# Google Cloud SDK
curl https://sdk.cloud.google.com | bash

# kubectl, k3d, Docker (see docs)
```

### 5-Minute Setup

```bash
# 1. Clone the repository
git clone https://github.com/YOUR-USERNAME/MLOps-AI-Homelab-IaC.git
cd MLOps-AI-Homelab-IaC

# 2. Copy configuration templates
cp config.example.yaml config.yaml
cp secrets.example.yaml secrets.yaml
cp terraform/terraform.tfvars.example terraform/terraform.tfvars

# 3. Edit configuration (add your GCP project ID, SSH keys, etc.)
vim config.yaml
vim secrets.yaml
vim terraform/terraform.tfvars

# 4. Encrypt secrets
ansible-vault encrypt secrets.yaml

# 5. Run pre-flight check
make check-deps

# 6. Deploy everything!
make deploy-all
```

**That's it!** In ~15 minutes, you'll have:
- ‚úÖ GCP VM running k3s control plane
- ‚úÖ ArgoCD, MLflow, Prometheus, Grafana deployed
- ‚úÖ On-prem k3d cluster connected via Tailscale
- ‚úÖ Sample ML model ready to deploy

---

## Repository Structure

```
.
‚îú‚îÄ‚îÄ config.yaml                    # Main configuration (copy from .example)
‚îú‚îÄ‚îÄ secrets.yaml                   # Sensitive data (encrypted with Ansible Vault)
‚îú‚îÄ‚îÄ Makefile                       # Orchestration commands
‚îÇ
‚îú‚îÄ‚îÄ terraform/                     # Cloud infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                    # GCP resources
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars           # Variables (gitignored)
‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfvars.example   # Template
‚îÇ
‚îú‚îÄ‚îÄ ansible/                       # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ setup-cloud.yml        # Cloud platform setup
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ setup-on-prem.yml      # On-prem setup (future)
‚îÇ   ‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/                # Base system configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ k3s-server/            # k3s control plane
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tailscale/             # VPN setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ argocd/                # GitOps controller
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mlflow/                # Model registry
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring/            # Observability stack
‚îÇ   ‚îî‚îÄ‚îÄ inventory/
‚îÇ       ‚îî‚îÄ‚îÄ gcp.ini                # Generated by Terraform
‚îÇ
‚îú‚îÄ‚îÄ scripts/                       # Helper scripts
‚îÇ   ‚îú‚îÄ‚îÄ pre-flight-check.sh        # Validate environment
‚îÇ   ‚îú‚îÄ‚îÄ setup-on-prem.sh           # Create k3d cluster
‚îÇ   ‚îú‚îÄ‚îÄ register-cluster.sh        # Connect clusters
‚îÇ   ‚îú‚îÄ‚îÄ validate-cloud.sh          # Post-deployment tests
‚îÇ   ‚îú‚îÄ‚îÄ validate-on-prem.sh        # On-prem validation
‚îÇ   ‚îî‚îÄ‚îÄ create-model.sh            # Model template generator
‚îÇ
‚îú‚îÄ‚îÄ templates/                     # Model templates
‚îÇ   ‚îú‚îÄ‚îÄ model-template/            # Skeleton for new models
‚îÇ   ‚îú‚îÄ‚îÄ k8s-manifests/             # Kubernetes YAML templates
‚îÇ   ‚îî‚îÄ‚îÄ workflows/                 # CI/CD templates
‚îÇ
‚îî‚îÄ‚îÄ docs/                          # Documentation
    ‚îú‚îÄ‚îÄ QUICKSTART.md
    ‚îú‚îÄ‚îÄ CONFIGURATION.md
    ‚îú‚îÄ‚îÄ TROUBLESHOOTING.md
    ‚îî‚îÄ‚îÄ ARCHITECTURE.md
```

---

## Configuration Guide

### config.yaml

Main configuration file. Key sections:

```yaml
project:
  name: "mlops-ai-homelab"
  owner: "your-github-username"  # CHANGE THIS

cloud:
  gcp:
    project_id: "your-gcp-project-id"  # CHANGE THIS
    region: "us-west1"
    zone: "us-west1-b"
    vm:
      machine_type: "e2-small"  # Adjust for your needs

platform:
  argocd:
    admin_password: "CHANGE_ME"  # Change this!
  
  mlflow:
    storage:
      size: "5Gi"
  
  monitoring:
    prometheus:
      retention: "7d"

models:
  - name: "iris-classifier"
    enabled: true
    framework: "scikit-learn"
    # ... (see config.example.yaml for full schema)
```

### secrets.yaml (Encrypted)

Sensitive data stored encrypted with Ansible Vault:

```yaml
gcp:
  service_account_key: |
    { "type": "service_account", ... }
  project_id: "your-gcp-project-id"

tailscale:
  auth_key: "tskey-auth-XXXXX"

github:
  personal_access_token: "ghp_XXXXX"

argocd:
  admin_password: "secure-password"

# ... (see secrets.example.yaml for full template)
```

**Managing Secrets:**

```bash
# Encrypt
ansible-vault encrypt secrets.yaml

# Edit
ansible-vault edit secrets.yaml

# View (read-only)
ansible-vault view secrets.yaml

# Decrypt (temporary)
ansible-vault decrypt secrets.yaml
```

### terraform.tfvars

Terraform variables (non-sensitive):

```hcl
gcp_project_id   = "your-gcp-project-id"
gcp_region       = "us-west1"
vm_machine_type  = "e2-small"
ssh_public_key   = "ssh-ed25519 AAAAC3NzaC1..."
```

---

## Makefile Commands

The `Makefile` provides ~30 commands for common operations:

### Setup & Validation

```bash
make check-deps        # Check if required tools are installed
make check-config      # Validate configuration files
make init              # Initialize project (first-time setup)
```

### Cloud Infrastructure

```bash
make cloud-plan        # Show Terraform plan
make cloud-deploy      # Deploy GCP infrastructure
make cloud-destroy     # Destroy GCP infrastructure (WARNING!)
make cloud-output      # Show Terraform outputs
```

### Platform Configuration

```bash
make cloud-configure   # Configure cloud platform with Ansible
make cloud-configure-tags TAGS=argocd,mlflow  # Configure specific components
```

### On-Premises Setup

```bash
make on-prem-setup     # Create k3d cluster
make on-prem-destroy   # Destroy k3d cluster
make on-prem-status    # Show cluster status
```

### Multi-Cluster Operations

```bash
make connect-clusters  # Register on-prem cluster with ArgoCD
make deploy-app        # Deploy sample application
```

### Full Deployment

```bash
make deploy-all        # Complete end-to-end deployment (15 mins)
make destroy-all       # Destroy entire platform (WARNING!)
```

### Monitoring & Validation

```bash
make validate-cloud    # Run post-deployment validation
make validate-on-prem  # Validate on-prem cluster
make show-urls         # Display all service URLs
make status            # Show overall platform status
```

### Secrets Management

```bash
make encrypt-secrets   # Encrypt secrets.yaml
make decrypt-secrets   # Decrypt secrets.yaml (temporary)
make edit-secrets      # Edit encrypted secrets
make view-secrets      # View encrypted secrets (read-only)
```

### Utilities

```bash
make ssh-cloud         # SSH into GCP VM
make logs-cloud        # Tail cloud logs
make logs-on-prem      # Tail on-prem logs
make clean             # Clean temporary files
```

---

## Deployment Workflows

### Workflow 1: Fresh Deployment

For the first time deployment:

```bash
# 1. Pre-flight check
make check-deps
make check-config

# 2. Deploy cloud infrastructure
make cloud-deploy        # ~5 minutes

# 3. Configure platform services
make cloud-configure     # ~5 minutes (enter Ansible Vault password)

# 4. Setup on-premises cluster
make on-prem-setup       # ~2 minutes

# 5. Connect clusters
make connect-clusters    # ~1 minute

# 6. Deploy sample app
make deploy-app          # ~2 minutes

# 7. Validate deployment
make validate-cloud
make validate-on-prem

# 8. View service URLs
make show-urls
```

**Total Time:** ~15 minutes

### Workflow 2: Single Command Deployment

Alternatively, use the all-in-one command:

```bash
make deploy-all
```

This runs all steps above sequentially.

### Workflow 3: Partial Deployment

Deploy only specific components:

```bash
# Only cloud infrastructure
make cloud-deploy

# Only ArgoCD and MLflow
make cloud-configure-tags TAGS=argocd,mlflow

# Only on-prem cluster
make on-prem-setup
```

### Workflow 4: Teardown

```bash
# Destroy everything (WARNING: Irreversible!)
make destroy-all

# Or destroy individually
make on-prem-destroy
make cloud-destroy
```

---

## Model Management

### Adding a New Model

```bash
# Generate model template
make new-model NAME=fraud-detector

# This creates:
# - Model source code structure
# - Kubernetes manifests
# - CI/CD workflow
# - Training script template
```

Edit the generated files:

```
models/fraud-detector/
‚îú‚îÄ‚îÄ train.py              # Your training logic
‚îú‚îÄ‚îÄ app.py                # Inference server
‚îú‚îÄ‚îÄ requirements.txt      # Dependencies
‚îú‚îÄ‚îÄ Dockerfile            # Container image
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_model.py
‚îî‚îÄ‚îÄ k8s/
    ‚îú‚îÄ‚îÄ deployment.yaml
    ‚îî‚îÄ‚îÄ service.yaml
```

### Deploying a New Model

1. Update `config.yaml`:

```yaml
models:
  - name: "fraud-detector"
    enabled: true
    framework: "pytorch"
    training:
      dataset: "fraud_data.csv"
      test_split: 0.2
    inference:
      port: 8080
      node_port: 30809
    deployment:
      namespace: "ml-apps"
      cluster: "k3d-on-premises"
```

2. Commit code to GitHub

3. CI/CD pipeline automatically:
   - Tests code
   - Scans for vulnerabilities
   - Trains model
   - Builds container
   - Deploys via ArgoCD

### Listing Deployed Models

```bash
make list-models
```

---

## Monitoring & Operations

### Accessing Services

After deployment, services are available at:

```bash
# View all URLs
make show-urls

# Output:
# ArgoCD:       http://<GCP-IP>:30080
# MLflow:       http://<GCP-IP>:30500
# Prometheus:   http://<GCP-IP>:30900
# Grafana:      http://<GCP-IP>:30300
# Alertmanager: http://<GCP-IP>:30930
```

Default credentials:
- **ArgoCD:** admin / (password from secrets.yaml)
- **Grafana:** admin / admin (change on first login)
- **MLflow:** No authentication (demo mode)

### Health Checks

```bash
# Overall status
make status

# Validate deployments
make validate-cloud
make validate-on-prem

# View logs
make logs-cloud      # Cloud control plane
make logs-on-prem    # On-prem ML apps
```

### SSH Access

```bash
# SSH into GCP VM
make ssh-cloud

# Or manually
ssh mlops@<GCP-IP>
```

### Kubernetes Access

```bash
# Get kubeconfig for cloud cluster
make kubeconfig-cloud

# Get kubeconfig for on-prem cluster
make kubeconfig-on-prem

# Use with kubectl
export KUBECONFIG=/tmp/k3s-control-plane-kubeconfig.yaml
kubectl get nodes

# Switch contexts
kubectl config use-context gcp
kubectl config use-context k3d-ml-worker
```

---

## Customization

### Changing Cloud Region

Edit `config.yaml`:

```yaml
cloud:
  gcp:
    region: "us-central1"
    zone: "us-central1-a"
```

Then redeploy:

```bash
make cloud-destroy
make cloud-deploy
```

### Adjusting VM Size

For more resources:

```yaml
cloud:
  gcp:
    vm:
      machine_type: "e2-medium"  # 2 vCPU, 4GB RAM
```

Cost: ~$26/month (vs $13 for e2-small)

### Customizing Prometheus Alerts

Edit alert thresholds in `config.yaml`:

```yaml
platform:
  monitoring:
    prometheus:
      alert_rules:
        high_cpu:
          threshold: 90  # Change from 80% to 90%
          for: "10m"     # Change from 5m to 10m
```

Apply changes:

```bash
make cloud-configure-tags TAGS=monitoring
```

### Adding New Services

Create a new Ansible role:

```bash
mkdir -p ansible/roles/my-service/tasks
vim ansible/roles/my-service/tasks/main.yml
```

Add to playbook:

```yaml
# ansible/playbooks/setup-cloud.yml
roles:
  - role: my-service
    tags: ['my-service']
```

Deploy:

```bash
make cloud-configure-tags TAGS=my-service
```

---

## Troubleshooting

### Common Issues

#### 1. Terraform Apply Fails

**Symptom:** `Error: Error creating instance`

**Causes:**
- GCP APIs not enabled
- Insufficient quota
- Invalid credentials

**Solution:**

```bash
# Enable required APIs
gcloud services enable compute.googleapis.com aiplatform.googleapis.com

# Check quota
gcloud compute project-info describe --project=YOUR-PROJECT-ID

# Re-authenticate
gcloud auth login
gcloud auth application-default login
```

#### 2. Ansible Connection Timeout

**Symptom:** `UNREACHABLE! => {"changed": false, "msg": "Failed to connect"}`

**Causes:**
- SSH key not added to GCP VM
- Firewall blocking port 22
- VM still booting

**Solution:**

```bash
# Wait for VM to be ready
sleep 30

# Test SSH manually
ssh mlops@<GCP-IP>

# Check firewall rules
gcloud compute firewall-rules list

# Re-run with verbose
cd ansible && ansible-playbook -vvv -i inventory/gcp.ini playbooks/setup-cloud.yml
```

#### 3. k3d Cluster Creation Fails

**Symptom:** `ERRO[0000] Failed to create cluster`

**Causes:**
- Docker not running
- Port already in use
- Insufficient resources

**Solution:**

```bash
# Check Docker
docker info

# Check port availability
lsof -i :6550  # API port
lsof -i :30808 # NodePort

# Delete conflicting cluster
k3d cluster list
k3d cluster delete ml-worker

# Retry with more verbose output
k3d cluster create ml-worker --verbose
```

#### 4. ArgoCD Can't Sync

**Symptom:** Applications stuck in "OutOfSync" state

**Causes:**
- GitHub repo not accessible
- Invalid kubeconfig for remote cluster
- RBAC permissions issue

**Solution:**

```bash
# Check ArgoCD logs
kubectl -n argocd logs -l app.kubernetes.io/name=argocd-server

# Verify repo access
argocd repo list

# Re-register cluster
argocd cluster add k3d-ml-worker --kubeconfig /tmp/k3d-ml-worker-kubeconfig.yaml

# Manual sync
argocd app sync iris-classifier --prune
```

#### 5. Tailscale Connection Issues

**Symptom:** Can't reach k3d cluster from GCP via Tailscale

**Causes:**
- Tailscale not running
- Wrong IP in TLS SAN
- Firewall blocking Tailscale

**Solution:**

```bash
# Check Tailscale status
tailscale status

# Reconnect
tailscale up

# Get current IP
tailscale ip -4

# Update k3d TLS SAN (requires cluster recreate)
k3d cluster delete ml-worker
make on-prem-setup  # Will detect new Tailscale IP
```

### Debug Mode

Run any command with verbose output:

```bash
# Terraform
cd terraform && terraform apply -var-file="terraform.tfvars" -debug

# Ansible
cd ansible && ansible-playbook -vvv -i inventory/gcp.ini playbooks/setup-cloud.yml

# kubectl
kubectl get pods -n ml-apps -v=8
```

### Rollback on Failure

If deployment fails, rollback:

```bash
# Partial rollback (keep cloud, destroy on-prem)
make on-prem-destroy

# Full rollback
make destroy-all
```

### Getting Help

```bash
# Show all available commands
make help

# Check pre-flight
make check-deps

# View status
make status

# View logs
make logs-cloud
make logs-on-prem
```

---

## Cost Optimization

### Monthly Costs

**Cloud Infrastructure:**
- GCP e2-small: ~$13/month
- GCP e2-micro (dev): ~$6/month
- Static IP (optional): ~$3/month

**Total:** $13-16/month

**Free Tier Services:**
- Tailscale: Free (up to 100 devices)
- Gemini API: Free (up to 1500 requests/day)
- GitHub Actions: Free (2000 minutes/month)
- GHCR: Free (500MB storage)

### Reducing Costs

```yaml
# Use smaller VM for dev
cloud:
  gcp:
    vm:
      machine_type: "e2-micro"  # 1 vCPU, 1GB RAM (~$6/month)

# Reduce Prometheus retention
platform:
  monitoring:
    prometheus:
      retention: "3d"  # Instead of 7d

# Use preemptible VM (not recommended for production)
# Add to terraform/main.tf:
resource "google_compute_instance" "control_plane" {
  scheduling {
    preemptible       = true
    automatic_restart = false
  }
}
```

### Auto-Shutdown Script

Stop VM when not in use:

```bash
# Stop VM
gcloud compute instances stop mlops-control-plane --zone us-west1-b

# Start VM
gcloud compute instances start mlops-control-plane --zone us-west1-b
```

Schedule with cron:

```bash
# Stop at midnight, start at 8 AM
0 0 * * * gcloud compute instances stop mlops-control-plane --zone us-west1-b
0 8 * * * gcloud compute instances start mlops-control-plane --zone us-west1-b
```

---

## Advanced Topics

### Multi-Environment Setup

```bash
# Create separate configs
cp config.yaml config.dev.yaml
cp config.yaml config.prod.yaml

# Deploy dev
make cloud-deploy CONFIG=config.dev.yaml

# Deploy prod
make cloud-deploy CONFIG=config.prod.yaml
```

### CI/CD Integration

Run in GitHub Actions:

```yaml
name: Deploy Infrastructure

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Deploy Cloud
        run: make cloud-deploy
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
```

### Remote State Backend

For team collaboration, use remote Terraform state:

```hcl
# terraform/main.tf
terraform {
  backend "gcs" {
    bucket = "your-terraform-state-bucket"
    prefix = "mlops-platform"
  }
}
```

Create bucket:

```bash
gsutil mb gs://your-terraform-state-bucket
gsutil versioning set on gs://your-terraform-state-bucket
```

---

## Security Best Practices

### 1. Secrets Management

‚úÖ **DO:**
- Encrypt `secrets.yaml` with Ansible Vault
- Use strong Ansible Vault passwords
- Store vault password in password manager
- Rotate secrets regularly

‚ùå **DON'T:**
- Commit unencrypted secrets
- Share vault password via email/Slack
- Use weak passwords

### 2. SSH Keys

```bash
# Generate dedicated key for platform
ssh-keygen -t ed25519 -C "mlops-platform" -f ~/.ssh/mlops-platform

# Add to ssh-agent
ssh-add ~/.ssh/mlops-platform

# Update config.yaml with public key
```

### 3. Firewall Rules

Restrict source ranges in production:

```yaml
# config.yaml
cloud:
  gcp:
    firewall:
      allow_k8s_api:
        source_ranges:
          - "YOUR_TAILSCALE_IP/32"  # Not 0.0.0.0/0
```

### 4. Service Accounts

Use dedicated service accounts with minimal permissions:

```bash
# Create dedicated SA
gcloud iam service-accounts create mlops-platform --display-name="MLOps Platform"

# Grant minimal roles
gcloud projects add-iam-policy-binding YOUR-PROJECT \
  --member="serviceAccount:mlops-platform@YOUR-PROJECT.iam.gserviceaccount.com" \
  --role="roles/compute.instanceAdmin.v1"
```

---

## Contributing

Contributions welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

---

## License

MIT License - See LICENSE file for details

---

## Support

- **Documentation:** [docs/](docs/)
- **Issues:** [GitHub Issues](https://github.com/YOUR-USERNAME/MLOps-AI-Homelab-IaC/issues)
- **Discussions:** [GitHub Discussions](https://github.com/YOUR-USERNAME/MLOps-AI-Homelab-IaC/discussions)

---

## Acknowledgments

Built with:
- [Terraform](https://www.terraform.io/)
- [Ansible](https://www.ansible.com/)
- [k3s](https://k3s.io/)
- [k3d](https://k3d.io/)
- [ArgoCD](https://argo-cd.readthedocs.io/)
- [MLflow](https://mlflow.org/)
- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/)
- [Tailscale](https://tailscale.com/)

---

**Happy Building!** üöÄ

For questions or issues, please open a GitHub issue or discussion.