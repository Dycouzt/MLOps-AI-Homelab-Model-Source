name: AI Log Analysis - Production Alert Handler

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: 'Cluster name (gcp/k3d)'
        required: true
        type: choice
        options:
          - gcp
          - k3d
      alert_name:
        description: 'Alert name from Prometheus'
        required: true
        type: string
      alert_severity:
        description: 'Alert severity (critical/warning/info)'
        required: true
        type: string
      pod_name:
        description: 'Pod name to fetch logs from'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        default: 'ml-apps'
        type: string

jobs:
  analyze-logs:
    name: AI-Powered Log Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl for target cluster
        run: |
          mkdir -p ~/.kube
          if [ "${{ inputs.cluster }}" == "gcp" ]; then
            echo "${{ secrets.KUBECONFIG_GCP }}" | base64 -d > ~/.kube/config
            kubectl config use-context gcp
          else
            echo "${{ secrets.KUBECONFIG_K3D }}" | base64 -d > ~/.kube/config
            kubectl config use-context k3d
          fi

      - name: Fetch pod logs
        id: get-logs
        run: |
          echo "Fetching logs for pod: ${{ inputs.pod_name }}"
          LOG_OUTPUT=$(kubectl logs ${{ inputs.pod_name }} -n ${{ inputs.namespace }} --tail=100 2>&1 || echo "Failed to fetch logs")
          echo "$LOG_OUTPUT" > pod-logs.txt
          LOG_ESCAPED=$(echo "$LOG_OUTPUT" | jq -Rs .)
          echo "LOGS=$LOG_ESCAPED" >> $GITHUB_OUTPUT

      - name: Get pod events
        id: get-events
        run: |
          echo "Fetching events for pod: ${{ inputs.pod_name }}"
          EVENTS=$(kubectl get events -n ${{ inputs.namespace }} --field-selector involvedObject.name=${{ inputs.pod_name }} --sort-by='.lastTimestamp' 2>&1 || echo "No events found")
          echo "$EVENTS" > pod-events.txt
          EVENTS_ESCAPED=$(echo "$EVENTS" | jq -Rs .)
          echo "EVENTS=$EVENTS_ESCAPED" >> $GITHUB_OUTPUT

      - name: AI Analysis with Gemini
        id: gemini-analysis
        run: |
          # Install Google Cloud SDK
          curl https://sdk.cloud.google.com | bash -s -- --disable-prompts
          source $HOME/google-cloud-sdk/path.bash.inc
          
          # Authenticate with service account
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 -d > /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          
          # Get access token
          ACCESS_TOKEN=$(gcloud auth print-access-token)

          # Escape logs/events for JSON
          LOGS_ESCAPED=$(echo '${{ steps.get-logs.outputs.LOGS }}' | jq -Rs .)
          EVENTS_ESCAPED=$(echo '${{ steps.get-events.outputs.EVENTS }}' | jq -Rs .)
          
          # Create JSON payload for Gemini API
          cat > gemini-request.json << EOF
          {
            "contents": [{
              "role": "user",
              "parts": [{
                "text": "You are an expert MLOps Site Reliability Engineer analyzing a production alert for a machine learning model serving system.\n\n**Cluster:** ${{ inputs.cluster }}\n**Alert Details:**\n- Alert Name: ${{ inputs.alert_name }}\n- Severity: ${{ inputs.alert_severity }}\n- Pod: ${{ inputs.pod_name }}\n- Namespace: ${{ inputs.namespace }}\n\n**Pod Logs (last 100 lines):**\n${LOGS_ESCAPED}\n\n**Kubernetes Events:**\n${EVENTS_ESCAPED}\n\n**Your Task:**\nProvide a concise markdown analysis with:\n1. **Root Cause Hypothesis** (3 most likely causes, ranked by probability)\n2. **Impact Assessment** (What systems/users are affected?)\n3. **Immediate Actions** (What should the on-call engineer do RIGHT NOW?)\n4. **Prevention Recommendations** (How to prevent this in the future?)\n\nFormat your response as markdown. Be specific and actionable. Focus on ML-specific issues (model loading, inference errors, resource constraints)."
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 1024,
              "topP": 0.95
            }
          }
          EOF
          
          # Call Gemini API
          ANALYSIS=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${{ secrets.GCP_PROJECT_ID }}/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent" \
            -d @gemini-request.json | jq -r '.candidates[0].content.parts[0].text // "âŒ Gemini API call failed. Check service account permissions."')

          echo "$ANALYSIS" > analysis-report.md
          echo "ANALYSIS<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Analysis to GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analysis = `${{ steps.gemini-analysis.outputs.ANALYSIS }}`;
            const issueBody = `
            ## ðŸš¨ Production Alert: ${{ inputs.alert_name }}
            
            **Severity:** ${{ inputs.alert_severity }}  
            **Cluster:** ${{ inputs.cluster }}  
            **Pod:** \`${{ inputs.pod_name }}\`  
            **Namespace:** \`${{ inputs.namespace }}\`  
            **Timestamp:** ${new Date().toISOString()}
            
            ---
            
            ## ðŸ¤– AI-Generated Analysis
            
            ${analysis}
            
            ---
            
            ## ðŸ“‹ Raw Data
            
            <details>
            <summary>Pod Logs (last 100 lines)</summary>
            
            \`\`\`
            ${{ steps.get-logs.outputs.LOGS }}
            \`\`\`
            </details>
            
            <details>
            <summary>Kubernetes Events</summary>
            
            \`\`\`
            ${{ steps.get-events.outputs.EVENTS }}
            \`\`\`
            </details>
            
            ---
            
            **Alert Source:** Prometheus Alertmanager  
            **Analysis Engine:** Google Gemini 2.5 Flash Lite
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ALERT] ${context.payload.inputs.alert_name} - ${context.payload.inputs.pod_name} (${context.payload.inputs.cluster})`,
              body: issueBody,
              labels: ['production-alert', 'ai-analysis', context.payload.inputs.alert_severity, context.payload.inputs.cluster]
            });

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: alert-analysis-artifacts
          path: |
            pod-logs.txt
            pod-events.txt
            analysis-report.md
