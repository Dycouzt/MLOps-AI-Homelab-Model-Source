name: AI Drift Detection Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  drift-detection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Load Historical Baseline Metrics from MLflow
        id: mlflow-metrics
        run: |
          METRICS=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.MLFLOW_TOKEN }}" \
            "${{ secrets.MLFLOW_METRICS_URL }}" | jq -r '.metrics // "NO_DATA"')

          echo "METRICS<<EOF" >> $GITHUB_OUTPUT
          echo "$METRICS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compute Drift
        id: drift
        run: |
          BASELINE_PCT=$(echo "${{ steps.mlflow-metrics.outputs.METRICS }}" | jq -r '.baseline_accuracy // 0')
          CURRENT_PCT=$(echo "${{ secrets.CURRENT_MODEL_ACCURACY }}" | jq -r '.accuracy // 0')

          DRIFT=$(echo "$BASELINE_PCT - $CURRENT_PCT" | bc)

          echo "DRIFT=$DRIFT" >> $GITHUB_OUTPUT
          echo "CURRENT_PCT=$CURRENT_PCT" >> $GITHUB_OUTPUT
          echo "BASELINE_PCT=$BASELINE_PCT" >> $GITHUB_OUTPUT

      - name: Generate Gemini Prompt
        id: gemini
        run: |
          PROMPT_TEXT=$(cat << 'EOF'
          You are an advanced MLOps drift-analysis system.

          Historical Metrics:
          ${{ steps.mlflow-metrics.outputs.METRICS }}

          Current Accuracy:
          ${{ steps.drift.outputs.CURRENT_PCT }}

          Baseline Accuracy:
          ${{ steps.drift.outputs.BASELINE_PCT }}

          Drift Percentage:
          ${{ steps.drift.outputs.DRIFT }}

          Your Task:
          Provide a markdown analysis containing:
          - Drift classification
          - Root cause hypothesis
          - Recommended actions (immediate, short-term, long-term)
          - Retraining decision and data strategy
          EOF
          )

          echo "PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Gemini API
        id: ai-analysis
        env:
          ACCESS_TOKEN: ${{ secrets.GCP_ACCESS_TOKEN }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          printf '%s' "${{ steps.gemini.outputs.PROMPT }}" > prompt.txt

          cat > gemini-request.json << EOF
          {
            "contents": [{
              "role": "user",
              "parts": [{
                "text": $(jq -Rs . < prompt.txt)
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 1024
            }
          }
          EOF

          RAW_ANALYSIS=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${GCP_PROJECT_ID}/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent" \
            -d @gemini-request.json | jq -r '.candidates[0].content.parts[0].text // "Gemini API call failed"')

          echo "$RAW_ANALYSIS" > drift-analysis.md

          SAFE_ANALYSIS=$(printf '%s' "$RAW_ANALYSIS" | jq -Rs .)

          echo "ANALYSIS=$SAFE_ANALYSIS" >> $GITHUB_OUTPUT
          echo "DRIFT_PERCENT=${{ steps.drift.outputs.DRIFT }}" >> $GITHUB_OUTPUT
          echo "CURRENT_PCT=${{ steps.drift.outputs.CURRENT_PCT }}" >> $GITHUB_OUTPUT
          echo "BASELINE_PCT=${{ steps.drift.outputs.BASELINE_PCT }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue for Drift Alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const drift = process.env.DRIFT_PERCENT;
            const analysis = JSON.parse(process.env.ANALYSIS);

            const title = `⚠️ Drift Detected: ${drift}%`;
            const body = analysis;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            })
        env:
          DRIFT_PERCENT: ${{ steps.ai-analysis.outputs.DRIFT_PERCENT }}
          ANALYSIS: ${{ steps.ai-analysis.outputs.ANALYSIS }}
