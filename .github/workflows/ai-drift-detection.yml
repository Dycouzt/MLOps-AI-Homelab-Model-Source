name: AI Model Drift Detection & Analysis

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name (e.g., iris-classifier)'
        required: true
        default: 'iris-classifier'
        type: string
      current_accuracy:
        description: 'Current accuracy (0.0-1.0)'
        required: true
        type: string
      baseline_accuracy:
        description: 'Baseline accuracy (0.0-1.0)'
        required: true
        type: string

jobs:
  analyze-drift:
    name: AI-Powered Drift Analysis
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    steps:
      - name: Fetch MLflow metrics
        id: mlflow-metrics
        run: |
          # Use secret for MLflow URI
          RUNS=$(curl -s "${MLFLOW_TRACKING_URI}/api/2.0/mlflow/experiments/get-by-name?experiment_name=iris-classification" | jq -r '.experiment.experiment_id')
          
          METRICS=$(curl -s "${MLFLOW_TRACKING_URI}/api/2.0/mlflow/runs/search" \
            -H "Content-Type: application/json" \
            -d "{\"experiment_ids\":[\"${RUNS}\"],\"max_results\":10,\"order_by\":[\"start_time DESC\"]}" | jq -c '.runs')
          
          echo "$METRICS" > mlflow-metrics.json
          
          ACCURACY_TREND=$(echo "$METRICS" | jq -r '[.[] | {
            run_id: .info.run_id,
            accuracy: (.data.metrics[] | select(.key=="accuracy") | .value),
            timestamp: .info.start_time
          }]')
          
          echo "METRICS<<EOF" >> $GITHUB_OUTPUT
          echo "$ACCURACY_TREND" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze drift with Gemini AI
        id: ai-analysis
        run: |
          # Install gcloud SDK
          curl https://sdk.cloud.google.com | bash -s -- --disable-prompts
          source $HOME/google-cloud-sdk/path.bash.inc
          
          # Authenticate with GCP using secret
          echo "${GCP_SERVICE_ACCOUNT_KEY}" | base64 -d > /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project ${GCP_PROJECT_ID}

          # Remove key file after authentication
          rm -f /tmp/gcp-key.json
          
          # Get access token
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          
          # Calculate drift percentage
          CURRENT=${{ inputs.current_accuracy }}
          BASELINE=${{ inputs.baseline_accuracy }}
          DRIFT=$(echo "scale=4; (($BASELINE - $CURRENT) / $BASELINE) * 100" | bc)
          
          # Build prompt text
          CURRENT_PCT=$(echo "scale=2; $CURRENT * 100" | bc)
          BASELINE_PCT=$(echo "scale=2; $BASELINE * 100" | bc)
          
          PROMPT_TEXT="You are an expert ML model monitoring specialist analyzing model performance degradation.\n\n**Model Drift Alert:**\n- Model: ${{ inputs.model_name }}\n- Current Accuracy: ${CURRENT} (${CURRENT_PCT}%)\n- Baseline Accuracy: ${BASELINE} (${BASELINE_PCT}%)\n- Drift: ${DRIFT}% decrease\n\n**Historical Metrics (last 10 runs):**\n\`\`\`json\n${{ steps.mlflow-metrics.outputs.METRICS }}\n\`\`\`\n\n**Your Task:**\nProvide a markdown analysis with:\n\n1. **Drift Classification:**\n   - Type: Data Drift, Concept Drift, or Model Decay?\n   - Severity: P0 (Critical), P1 (High), P2 (Medium), P3 (Low)?\n\n2. **Root Cause Hypothesis:**\n   - What are the 3 most likely causes?\n   - Which is most probable based on the metric trend?\n\n3. **Recommended Actions:**\n   - Immediate: What should we do RIGHT NOW?\n   - Short-term: Actions for this week\n   - Long-term: How to prevent this?\n\n4. **Retraining Decision:**\n   - Should we retrain immediately? Yes/No/Wait\n   - If yes, what data should we use?\n   - If wait, what threshold should trigger retraining?\n\nBe specific and data-driven. Reference the historical trend. Format as markdown. Keep under 600 words."
          
          cat > gemini-request.json << EOF
          {
            "contents": [{
              "role": "user",
              "parts": [{
                "text": $(echo "$PROMPT_TEXT" | jq -Rs .)
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 1024,
              "topP": 0.95
            }
          }
          EOF
          
          ANALYSIS=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${GCP_PROJECT_ID}/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent" \
            -d @gemini-request.json | jq -r '.candidates[0].content.parts[0].text // "âŒ Gemini API call failed"')
          
          echo "$ANALYSIS" > drift-analysis.md
          echo "ANALYSIS<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "DRIFT_PERCENT=$DRIFT" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue for Drift Alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analysis = `${{ steps.ai-analysis.outputs.ANALYSIS }}`;
            const driftPercent = `${{ steps.ai-analysis.outputs.DRIFT_PERCENT }}`;
            
            let severity = 'P2';
            let severityLabel = 'model-drift-medium';
            if (parseFloat(driftPercent) > 10) {
              severity = 'P0';
              severityLabel = 'model-drift-critical';
            } else if (parseFloat(driftPercent) > 5) {
              severity = 'P1';
              severityLabel = 'model-drift-high';
            }
            
            const issueBody = `
            ## ðŸ“‰ Model Drift Detected: ${{ inputs.model_name }}
            
            **Severity:** ${severity}  
            **Current Accuracy:** ${{ inputs.current_accuracy }} (${{ steps.ai-analysis.outputs.CURRENT_PCT }}%)  
            **Baseline Accuracy:** ${{ inputs.baseline_accuracy }} (${{ steps.ai-analysis.outputs.BASELINE_PCT }}%)  
            **Drift:** ${driftPercent}% decrease  
            **Detection Time:** ${new Date().toISOString()}
            
            ---
            
            ## ðŸ¤– AI-Generated Drift Analysis
            
            ${analysis}
            
            ---
            
            ## ðŸ“Š Quick Actions
            
            - [ ] Review the AI analysis and root cause hypothesis
            - [ ] Check recent data quality issues
            - [ ] Investigate feature distribution changes
            - [ ] Decide on retraining strategy
            - [ ] Update monitoring thresholds if needed
            
            ---
            
            ## ðŸ”— Resources
            
            - [MLflow Experiment](${MLFLOW_TRACKING_URI}/#/experiments)
            - [Model Deployment](https://github.com/${{ github.repository }}/actions)
            - [Grafana Dashboard](http://34.145.47.22:30300)
            
            ---
            
            **Analysis Engine:** Google Gemini 2.0 Flash  
            **Auto-generated:** ${new Date().toISOString()}
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[MODEL DRIFT] ${severity} - ${{ inputs.model_name }} accuracy dropped ${driftPercent}%`,
              body: issueBody,
              labels: ['model-drift', 'ai-analysis', severityLabel, 'ml-ops']
            });

      - name: Upload drift analysis report
        uses: actions/upload-artifact@v4
        with:
          name: drift-analysis-report
          path: |
            drift-analysis.md
            mlflow-metrics.json
