name: AI Pipeline Failure Triage

on:
  workflow_run:
    workflows: ["ML Model CI/CT/CD Pipeline"]
    types: [completed]

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  triage-failure:
    name: AI-Powered Failure Analysis
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download training logs artifact
        uses: actions/download-artifact@v4
        with:
          name: train-logs
          path: logs

      - name: Read logs for AI
        id: read-logs
        run: |
          LOGS=$(head -c 5000 logs/train.log)
          echo "LOGS<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" | sed 's/%/%%/g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download other artifacts safely
        id: download-artifacts
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            let artifactInfo = {};
            for (const art of artifacts.data.artifacts) {
              if (art.name === "bandit-report") artifactInfo.bandit_url = art.archive_download_url;
              if (art.name === "trivy-results") artifactInfo.trivy_url = art.archive_download_url;
            }

            core.setOutput('artifacts', JSON.stringify(artifactInfo));

      - name: Analyze failure with Gemini AI
        id: ai-analysis
        run: |
          curl https://sdk.cloud.google.com | bash -s -- --disable-prompts
          source $HOME/google-cloud-sdk/path.bash.inc

          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 -d > /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

          ACCESS_TOKEN=$(gcloud auth print-access-token)
          FAILURE_LOGS='${{ steps.read-logs.outputs.LOGS }}'

          # Determine failure type based on failed job name
          FAILED_JOB=$(echo "${{ github.event.workflow_run.name }}" | tr '[:upper:]' '[:lower:]')
          if [[ "$FAILED_JOB" == *"sast"* ]] || [[ "$FAILED_JOB" == *"bandit"* ]]; then
            FAILURE_TYPE="Security Scan (SAST)"
            PROMPT_CONTEXT="You are a DevSecOps security specialist. A SAST security scan failed."
          elif [[ "$FAILED_JOB" == *"train"* ]] || [[ "$FAILED_JOB" == *"training"* ]]; then
            FAILURE_TYPE="Model Training"
            PROMPT_CONTEXT="You are an ML engineer. Model training or validation failed."
          elif [[ "$FAILED_JOB" == *"test"* ]]; then
            FAILURE_TYPE="Unit Tests"
            PROMPT_CONTEXT="You are a Python testing expert. Unit tests failed."
          else
            FAILURE_TYPE="Pipeline Failure"
            PROMPT_CONTEXT="You are a DevOps/MLOps engineer. A CI/CD pipeline step failed."
          fi

          # Construct Gemini prompt
          PROMPT_TEXT="${PROMPT_CONTEXT}\n\n**Pipeline Failure Details:**\n- Workflow: ${{ github.event.workflow_run.name }}\n- Failed Job: $FAILED_JOB\n- Branch: ${{ github.event.workflow_run.head_branch }}\n- Commit: ${{ github.event.workflow_run.head_commit.message }}\n\n**Logs (excerpt):**\n\`\`\`\n$FAILURE_LOGS\n\`\`\`\n\n**Your Task:**\nProvide a markdown analysis with:\n1. **Root Cause** (What exactly caused the failure?)\n2. **Risk Assessment** (Is this a blocker?)\n3. **Fix Instructions** (Step-by-step with specific commands/code)\n4. **Prevention** (How to avoid this?)\n\nBe specific and actionable. Keep under 500 words."

          cat > gemini-request.json << EOF
          {
            "contents": [{
              "role": "user",
              "parts": [{
                "text": $(echo "$PROMPT_TEXT" | jq -Rs .)
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 1024,
              "topP": 0.95
            }
          }
          EOF

          # Call Gemini API
          ANALYSIS=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${{ secrets.GCP_PROJECT_ID }}/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent" \
            -d @gemini-request.json | jq -r '.candidates[0].content.parts[0].text // "âŒ Gemini API call failed"')

          echo "$ANALYSIS" > triage-report.md
          echo "ANALYSIS<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" | sed 's/%/%%/g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "FAILURE_TYPE=$FAILURE_TYPE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        env:
          ANALYSIS_CONTENT: ${{ steps.ai-analysis.outputs.ANALYSIS }}
          FAILURE_TYPE: ${{ steps.ai-analysis.outputs.FAILURE_TYPE }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analysis = process.env.ANALYSIS_CONTENT;
            const failureType = process.env.FAILURE_TYPE;

            let severityLabel = 'pipeline-failure';
            if (failureType.includes('Security')) severityLabel = 'security-issue';
            if (failureType.includes('Training')) severityLabel = 'ml-model-issue';

            const issueBody = [
              `## ðŸ”´ Pipeline Failure: ${failureType}`,
              '',
              `**Failure Type:** ${failureType}`,
              '',
              '---',
              '',
              '## ðŸ¤– AI-Generated Triage Analysis',
              '',
              analysis,
              '',
              '---',
              '',
              '## ðŸ“‹ Quick Actions',
              '',
              '- [ ] Review the AI analysis',
              '- [ ] Apply the suggested fix',
              '- [ ] Test locally before pushing',
              '',
              '---',
              '',
              '**Triage Engine:** Google Gemini 2.5 Flash Lite',
              `**Auto-generated:** ${new Date().toISOString()}`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[PIPELINE FAILURE] ${failureType} - ${context.payload.workflow_run.head_sha.substring(0,7)}`
              body: issueBody,
              labels: ['pipeline-failure', 'ai-triage', severityLabel]
            });

      - name: Upload triage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-triage-report
          path: triage-report.md
