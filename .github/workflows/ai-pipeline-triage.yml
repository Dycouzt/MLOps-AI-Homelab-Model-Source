name: AI Pipeline Failure Triage

on:
  workflow_run:
    workflows: ["ML Model CI/CT/CD Pipeline"]
    types:
      - completed

jobs:
  triage-failure:
    name: AI-Powered Failure Analysis
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'Dycouzt/MLOps-AI-Homelab-Model-Source' && github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get workflow run details
        id: workflow-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
              filter: 'latest'
            });
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let failureLogs = '';
            if (failedJobs.length > 0) {
              const jobId = failedJobs[0].id;
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: jobId
                });
                failureLogs = logs.data || 'Could not retrieve logs';
              } catch (error) {
                failureLogs = `Error fetching logs: ${error.message}`;
              }
            }

            // Mask secrets in logs
            failureLogs = failureLogs.replace(/(password|secret|key|token)[^=\s:]*/gi, '***');

            const failureInfo = {
              workflow_name: run.data.name,
              run_url: run.data.html_url,
              failed_job_name: failedJobs.length > 0 ? failedJobs[0].name : 'Unknown',
              failed_step: failedJobs.length > 0 ? failedJobs[0].steps.find(s => s.conclusion === 'failure')?.name : 'Unknown',
              commit_message: run.data.head_commit.message,
              commit_sha: run.data.head_sha.substring(0, 7),
              branch: run.data.head_branch,
              logs: failureLogs.substring(0, 5000)
            };

            core.setOutput('failure_info', JSON.stringify(failureInfo));
            return failureInfo

      - name: Download artifacts from failed run
        id: download-artifacts
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const banditArtifact = artifacts.data.artifacts.find(a => a.name === 'bandit-report');
            const trivyArtifact = artifacts.data.artifacts.find(a => a.name === 'trivy-results');

            let artifactInfo = {};
            if (banditArtifact) artifactInfo.bandit_url = banditArtifact.archive_download_url;
            if (trivyArtifact) artifactInfo.trivy_url = trivyArtifact.archive_download_url;

            core.setOutput('artifacts', JSON.stringify(artifactInfo));
            return artifactInfo

      - name: Analyze failure with Gemini AI
        id: ai-analysis
        run: |
          curl https://sdk.cloud.google.com | bash -s -- --disable-prompts
          source $HOME/google-cloud-sdk/path.bash.inc
          
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 -d > /tmp/gcp-key.json
          chmod 600 /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          ACCESS_TOKEN=$(gcloud auth print-access-token)

          FAILURE_INFO='${{ steps.workflow-info.outputs.failure_info }}'
          LOGS=$(echo "$FAILURE_INFO" | jq -r '.logs')

          # Mask any remaining sensitive patterns
          LOGS=$(echo "$LOGS" | sed -E 's/(password|secret|key|token)[^=\s:]*/***/gi')

          PROMPT_TEXT="You are an MLOps/DevSecOps specialist. Analyze the following failure:\n$(echo "$LOGS")"

          cat > gemini-request.json << EOF
          {
            "contents": [{"role":"user","parts":[{"text": $(echo "$PROMPT_TEXT" | jq -Rs .)}]}],
            "generationConfig":{"temperature":0.2,"maxOutputTokens":1024,"topP":0.95}
          }
          EOF

          ANALYSIS=$(curl -s -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/${{ secrets.GCP_PROJECT_ID }}/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent" \
            -d @gemini-request.json | jq -r '.candidates[0].content.parts[0].text // "âŒ Gemini API call failed."')

          echo "$ANALYSIS" > triage-report.md
          echo "ANALYSIS<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue with Triage Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const failureInfo = JSON.parse('${{ steps.workflow-info.outputs.failure_info }}');
            const analysis = `${{ steps.ai-analysis.outputs.ANALYSIS }}`;
            const issueBody = `
            ## ðŸ”´ Pipeline Failure: ${failureInfo.failed_job_name}
            **Branch:** \`${failureInfo.branch}\`  
            **Commit:** ${failureInfo.commit_sha} - ${failureInfo.commit_message}  
            **Workflow Run:** ${failureInfo.run_url}
            
            ---\n
            ## ðŸ¤– AI-Generated Triage Analysis\n
            ${analysis}
            
            ---\n
            <details>
            <summary>ðŸ“Š View Logs (masked)</summary>
            \`\`\`
            ${failureInfo.logs}
            \`\`\`
            </details>
            `;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[PIPELINE FAILURE] ${failureInfo.failed_job_name} - ${failureInfo.commit_sha}`,
              body: issueBody,
              labels: ['pipeline-failure', 'ai-triage']
            })

      - name: Upload triage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-triage-report
          path: triage-report.md
